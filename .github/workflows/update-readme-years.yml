name: Update experience (years, months, days) in README

on:
  schedule:
    - cron: "0 5 * * *"   # runs daily at 05:00 UTC; adjust if needed
  workflow_dispatch: {}    # allows manual runs from Actions

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute years/months/days since start date (SÃ£o Paulo timezone)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          import os

          # >>> SET YOUR EXACT START DATE (YYYY-MM-DD) <<<
          START_DATE_STR = "2014-01-01"  # e.g., "2014-03-01"

          start = datetime.strptime(START_DATE_STR, "%Y-%m-%d").date()
          today = datetime.now(ZoneInfo("America/Sao_Paulo")).date()

          if today < start:
              years = months = days = 0
          else:
              years  = today.year  - start.year
              months = today.month - start.month
              days   = today.day   - start.day

              # Borrow days from previous month if needed
              if days < 0:
                  first_of_month = today.replace(day=1)
                  prev_month_last_day = (first_of_month - timedelta(days=1)).day
                  days += prev_month_last_day
                  months -= 1

              # Borrow months from previous year if needed
              if months < 0:
                  months += 12
                  years -= 1

          def unit(n, singular, plural):
              return f"{n} {singular if n == 1 else plural}"

          phrase = f"{unit(years,'year','years')}, {unit(months,'month','months')}, and {unit(days,'day','days')}"

          # Export to GitHub Actions outputs
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"EXPERIENCE_YMD={phrase}\n")
          PY

      - name: Replace placeholder in README.md
        shell: bash
        env:
          VALUE: ${{ steps.compute.outputs.EXPERIENCE_YMD }}
        run: |
          set -euo pipefail
          README_PATH="README.md"
          if [[ ! -f "$README_PATH" ]]; then
            echo "File not found: $README_PATH"
            exit 1
          fi
          python - <<'PY'
          import os, sys
          path = "README.md"
          value = os.environ["VALUE"]
          with open(path, "r", encoding="utf-8") as f:
              content = f.read()
          content_new = content.replace("<!--YEARS_OF_EXPERIENCE-->", value)
          if content_new != content:
              with open(path, "w", encoding="utf-8") as f:
                  f.write(content_new)
              print("UPDATED")
          else:
              print("NOCHANGE")
          PY

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail
          # Check if file changed
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "chore: update experience to '${{ steps.compute.outputs.EXPERIENCE_YMD }}'"
            git push
          else          else
            echo "No changes to commit."
