
name: Update experience (years, months, days) in README

on:
  schedule:
    - cron: "0 5 * * *"   # runs daily at 05:00 UTC
  workflow_dispatch: {}

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute years/months/days since start date (SÃ£o Paulo timezone)
        id: compute
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          import os

          # Exact start date
          START_DATE_STR = "2013-11-01"  # YYYY-MM-DD

          start = datetime.strptime(START_DATE_STR, "%Y-%m-%d").date()
          today = datetime.now(ZoneInfo("America/Sao_Paulo")).date()

          if today < start:
              years = months = days = 0
          else:
              years  = today.year  - start.year
              months = today.month - start.month
              days   = today.day   - start.day

              # Borrow days from previous month if needed
              if days < 0:
                  first_of_month = today.replace(day=1)
                  prev_month_last_day = (first_of_month - timedelta(days=1)).day
                  days += prev_month_last_day
                  months -= 1

              # Borrow months from previous year if needed
              if months < 0:
                  months += 12
                  years -= 1

          def unit(n, singular, plural):
              return f"{n} {singular if n == 1 else plural}"

          phrase = f"{unit(years,'year','years')}, {unit(months,'month','months')}, and {unit(days,'day','days')}"
          print("Computed experience:", phrase)

          # Export to GitHub Actions outputs
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"EXPERIENCE_YMD={phrase}\n")
          PY

      - name: Replace placeholder in README.md
        shell: bash
        env:
          VALUE: ${{ steps.compute.outputs.EXPERIENCE_YMD }}
        run: |
          set -euo pipefail
          README_PATH="README.md"
          echo "VALUE='${VALUE}'"

          if [[ -z "${VALUE}" ]]; then
            echo "ERROR: EXPERIENCE_YMD output is empty."
            exit 1
          fi

          if [[ ! -f "${README_PATH}" ]]; then
            echo "ERROR: File not found: ${README_PATH}"
            exit 1
          fi

          # Update the placeholder using Python (avoids sed quoting issues)
          python - <<'PY'
          import os
          path = "README.md"
          value = os.environ["VALUE"]
          with open(path, "r", encoding="utf-8") as f:
              content = f.read()
          new_content = content.replace("<!--YEARS_OF_EXPERIENCE-->", value)
          if new_content != content:
              with open(path, "w", encoding="utf-8") as f:
                  f.write(new_content)
              print("UPDATED")
          else:
              print("NOCHANGE")
          PY

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail
          # Commit only if there are changes in the working tree
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md

            # Experience text from previous step; fallback to N/A if empty
            EXP="${{ steps.compute.outputs.EXPERIENCE_YMD }}"
            if [[ -z "${EXP}" ]]; then
              EXP="N/A"
            fi

            git commit -m "chore: update            git commit -m "chore: update experience to '${EXP}'"
            git push
          else
            echo "No changes to commit."